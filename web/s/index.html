<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shared Note - Better Keep</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="View a shared note from Better Keep Notes">
  <meta name="robots" content="noindex, nofollow">

  <!-- Firebase (Modular SDK via CDN for named database support) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { addDoc, collection, connectFirestoreEmulator, doc, getDoc, getFirestore, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
    import { connectStorageEmulator, getDownloadURL, getStorage, ref } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js';

    const isLocalDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

    // Load Firebase config from JSON file or Firebase Hosting's auto-config
    async function loadFirebaseConfig() {
      // Try Firebase Hosting's auto-config first (works on Firebase Hosting)
      if (!isLocalDevelopment) {
        try {
          const response = await fetch('/__/firebase/init.json');
          if (response.ok) {
            console.log('Loaded Firebase config from hosting');
            return await response.json();
          }
        } catch (e) {
          // Fall through to JSON file
        }
      }

      // Load from JSON file
      const response = await fetch('/firebase-config.json');
      if (!response.ok) throw new Error('Failed to load Firebase config');
      return await response.json();
    }

    try {
      const FIREBASE_CONFIG = await loadFirebaseConfig();

      // Initialize Firebase
      const app = initializeApp(FIREBASE_CONFIG);

      // Use named database in production, default for emulators
      const databaseId = isLocalDevelopment ? '(default)' : 'better-keep';
      const db = getFirestore(app, databaseId);
      const storage = getStorage(app);

      // Connect to emulators if local
      if (isLocalDevelopment) {
        console.log('Running on localhost - connecting to Firebase emulators');
        connectFirestoreEmulator(db, 'localhost', 8080);
        connectStorageEmulator(storage, 'localhost', 9199);
      }

      // Export to window for use in the rest of the script
      window.firebaseDb = db;
      window.firebaseStorage = storage;
      window.firebaseModular = { collection, doc, getDoc, addDoc, onSnapshot, ref, getDownloadURL };
      window.firebaseReady = true;
      window.dispatchEvent(new Event('firebase-ready'));
    } catch (error) {
      console.error('Failed to initialize Firebase:', error);
      window.firebaseError = error;
      window.dispatchEvent(new Event('firebase-error'));
    }
  </script>

  <!-- Marked for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --primary: #FFD54F;
      --primary-dark: #FFC107;
      --accent: #7C4DFF;
      --accent-dark: #536DFE;
      --bg-dark: #121212;
      --bg-card: #1E1E1E;
      --bg-surface: #252525;
      --text-primary: #FFFFFF;
      --text-secondary: #B0B0B0;
      --text-muted: #757575;
      --border-subtle: rgba(255, 255, 255, 0.1);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.4);
      --radius-md: 12px;
      --radius-lg: 20px;
      --transition-normal: 0.3s ease;
      --success: #4CAF50;
      --error: #EF5350;
      --warning: #FF9800;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: var(--bg-dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: var(--text-primary);
    }

    .container {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 32px;
      max-width: 800px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-subtle);
      margin-top: 40px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
    }

    .header-text h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .header-text p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Status screens */
    .status-screen {
      text-align: center;
      padding: 40px 20px;
    }

    .status-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 40px;
    }

    .status-icon.loading {
      background: rgba(124, 77, 255, 0.1);
    }

    .status-icon.pending {
      background: rgba(255, 152, 0, 0.1);
    }

    .status-icon.approved {
      background: rgba(76, 175, 80, 0.1);
    }

    .status-icon.error {
      background: rgba(239, 83, 80, 0.1);
    }

    .status-screen h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .status-screen p {
      color: var(--text-secondary);
      margin-bottom: 24px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-subtle);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Request access form */
    .request-form {
      max-width: 400px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 16px;
      transition: border-color var(--transition-normal);
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-normal);
      width: 100%;
      margin-top: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(124, 77, 255, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
    }

    /* Note content */
    .note-content {
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      padding: 24px;
      margin-top: 24px;
    }

    .note-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .note-body {
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .note-body h1,
    .note-body h2,
    .note-body h3 {
      color: var(--text-primary);
      margin-top: 24px;
      margin-bottom: 12px;
    }

    .note-body h1:first-child {
      margin-top: 0;
    }

    .note-body p {
      margin-bottom: 16px;
    }

    .note-body ul,
    .note-body ol {
      margin-left: 24px;
      margin-bottom: 16px;
    }

    .note-body li {
      margin-bottom: 8px;
    }

    .note-body code {
      background: var(--bg-dark);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 14px;
    }

    .note-body pre {
      background: var(--bg-dark);
      padding: 16px;
      border-radius: var(--radius-md);
      overflow-x: auto;
      margin-bottom: 16px;
    }

    .note-body pre code {
      background: none;
      padding: 0;
    }

    .note-body blockquote {
      border-left: 4px solid var(--accent);
      padding-left: 16px;
      margin: 16px 0;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Attachments */
    .attachments-section {
      margin-top: 24px;
    }

    .attachments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .attachment-item {
      background: var(--bg-dark);
      border-radius: var(--radius-md);
      overflow: hidden;
      position: relative;
    }

    .attachment-item img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      cursor: pointer;
      transition: opacity var(--transition-normal);
    }

    .attachment-item img:hover {
      opacity: 0.8;
    }

    .attachment-item.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .attachment-audio {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .attachment-audio .audio-icon {
      font-size: 32px;
      text-align: center;
    }

    .attachment-audio .audio-title {
      font-size: 12px;
      text-align: center;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .attachment-audio audio {
      width: 100%;
      height: 32px;
    }

    /* Lightbox */
    .lightbox {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    }

    .lightbox.active {
      display: flex;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bg-surface);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Security info */
    .security-info {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(76, 175, 80, 0.1);
      padding: 16px;
      border-radius: var(--radius-md);
      margin-top: 24px;
    }

    .security-info svg {
      width: 24px;
      height: 24px;
      color: var(--success);
      flex-shrink: 0;
    }

    .security-info p {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Footer */
    .footer {
      margin-top: 32px;
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
    }

    .footer a {
      color: var(--accent);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 20px;
        margin-top: 20px;
      }

      .header {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <img src="/icons/logo.png" alt="Better Keep" class="logo">
      <div class="header-text">
        <h1>Shared Note</h1>
        <p>Securely shared via Better Keep Notes</p>
      </div>
    </div>

    <!-- Loading state -->
    <div id="loading-screen" class="status-screen">
      <div class="status-icon loading">
        <div class="spinner"></div>
      </div>
      <h2>Loading...</h2>
      <p>Retrieving share information</p>
    </div>

    <!-- Request access state -->
    <div id="request-screen" class="status-screen" style="display: none;">
      <div class="status-icon pending">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          style="width: 40px; height: 40px; color: var(--warning);">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
          <path d="M7 11V7a5 5 0 0 1 10 0v4" />
        </svg>
      </div>
      <h2>Access Required</h2>
      <p>This note is protected. Request access from the owner to view it.</p>

      <div class="request-form">
        <div class="form-group">
          <label for="device-name">Your Name / Device</label>
          <input type="text" id="device-name" placeholder="e.g., John's iPhone" required>
        </div>
        <button class="btn" id="request-btn" onclick="requestAccess()">
          Request Access
        </button>
      </div>
    </div>

    <!-- Pending approval state -->
    <div id="pending-screen" class="status-screen" style="display: none;">
      <div class="status-icon pending">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          style="width: 40px; height: 40px; color: var(--warning);">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
      </div>
      <h2>Waiting for Approval</h2>
      <p>Your request has been sent. The owner needs to approve your access.</p>
      <p id="pending-info" style="font-size: 12px; color: var(--text-muted);"></p>
      <button class="btn btn-secondary" onclick="checkStatus()" style="margin-top: 16px;">
        Check Status
      </button>
    </div>

    <!-- Note content (approved) -->
    <div id="content-screen" style="display: none;">
      <div class="note-content">
        <div id="note-title" class="note-title"></div>
        <div id="note-body" class="note-body"></div>

        <!-- Attachments section -->
        <div id="attachments-section" class="attachments-section" style="display: none;">
          <div id="attachments-grid" class="attachments-grid"></div>
        </div>

      </div>

      <div class="security-info">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
          <path d="M9 12l2 2 4-4" />
        </svg>
        <p>This note was encrypted end-to-end. The content is decrypted only in your browser.</p>
      </div>
    </div>

    <!-- Lightbox for images -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
      <button class="lightbox-close" onclick="closeLightbox()">Ã—</button>
      <img id="lightbox-img" src="" alt="Full size image">
    </div>

    <!-- Error states -->
    <div id="expired-screen" class="status-screen" style="display: none;">
      <div class="status-icon error">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          style="width: 40px; height: 40px; color: var(--error);">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
          <line x1="4" y1="4" x2="20" y2="20" />
        </svg>
      </div>
      <h2>Link Expired</h2>
      <p>This share link has expired. Please ask the owner for a new link.</p>
    </div>

    <div id="revoked-screen" class="status-screen" style="display: none;">
      <div class="status-icon error">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          style="width: 40px; height: 40px; color: var(--error);">
          <circle cx="12" cy="12" r="10" />
          <line x1="4.93" y1="4.93" x2="19.07" y2="19.07" />
        </svg>
      </div>
      <h2>Link Revoked</h2>
      <p>This share link has been revoked by the owner.</p>
    </div>

    <div id="denied-screen" class="status-screen" style="display: none;">
      <div class="status-icon error">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          style="width: 40px; height: 40px; color: var(--error);">
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
      </div>
      <h2>Access Denied</h2>
      <p>The owner has denied your access request.</p>
    </div>

    <div id="not-found-screen" class="status-screen" style="display: none;">
      <div class="status-icon error">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          style="width: 40px; height: 40px; color: var(--error);">
          <circle cx="11" cy="11" r="8" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
          <line x1="8" y1="11" x2="14" y2="11" />
        </svg>
      </div>
      <h2>Share Not Found</h2>
      <p>This share link doesn't exist or has been deleted.</p>
    </div>

    <div id="error-screen" class="status-screen" style="display: none;">
      <div class="status-icon error">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          style="width: 40px; height: 40px; color: var(--error);">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
          <line x1="12" y1="9" x2="12" y2="13" />
          <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>
      </div>
      <h2>Something Went Wrong</h2>
      <p id="error-message">An error occurred while loading the share.</p>
      <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 16px;">
        Try Again
      </button>
    </div>
  </div>

  <div class="footer">
    <p>Powered by <a href="https://betterkeep.app">Better Keep Notes</a></p>
  </div>

  <script>
    // Wait for Firebase to be ready
    function waitForFirebase() {
      return new Promise((resolve) => {
        if (window.firebaseReady) {
          resolve();
        } else {
          window.addEventListener('firebase-ready', resolve);
        }
      });
    }

    // Firebase instances (initialized asynchronously)
    let db = null;
    let storage = null;
    let fbModular = null;

    // State
    let shareId = null;
    let shareKey = null;
    let requestId = null;
    let shareData = null;
    let requestListener = null; // Real-time listener for request status

    // Screens
    const screens = {
      loading: document.getElementById('loading-screen'),
      request: document.getElementById('request-screen'),
      pending: document.getElementById('pending-screen'),
      content: document.getElementById('content-screen'),
      expired: document.getElementById('expired-screen'),
      revoked: document.getElementById('revoked-screen'),
      denied: document.getElementById('denied-screen'),
      notFound: document.getElementById('not-found-screen'),
      error: document.getElementById('error-screen'),
    };

    function showScreen(name) {
      for (const s of Object.values(screens)) {
        s.style.display = 'none';
      }
      if (screens[name]) {
        screens[name].style.display = 'block';
      }
    }

    function showError(message) {
      document.getElementById('error-message').textContent = message;
      showScreen('error');
    }

    // Parse URL
    function parseUrl() {
      const path = window.location.pathname;
      const match = path.match(/\/s\/([a-zA-Z0-9]+)/);
      if (match) {
        shareId = match[1];
      }

      // Get key from fragment (never sent to server)
      const fragment = window.location.hash;
      if (fragment && fragment.length > 1) {
        shareKey = fragment.substring(1);
      }

      // Get stored request ID
      requestId = localStorage.getItem(`share_request_${shareId}`);
    }

    // Load share data
    async function loadShare() {
      if (!shareId) {
        showScreen('notFound');
        return;
      }

      if (!shareKey) {
        showError('Invalid share link - missing decryption key');
        return;
      }

      try {
        const { doc: docFn, getDoc } = fbModular;
        const docSnap = await getDoc(docFn(db, 'shares', shareId));

        if (!docSnap.exists()) {
          showScreen('notFound');
          return;
        }

        shareData = docSnap.data();

        // Check status
        if (shareData.status === 'revoked') {
          showScreen('revoked');
          return;
        }

        // Check expiry
        const expiresAt = new Date(shareData.expires_at);
        if (new Date() > expiresAt) {
          showScreen('expired');
          return;
        }

        // If we have a previous request, check its status
        if (requestId) {
          await checkRequestStatus();
        } else {
          showScreen('request');
        }
      } catch (error) {
        console.error('Error loading share:', error);
        showError('Failed to load share: ' + error.message);
      }
    }

    // Request access
    async function requestAccess() {
      const deviceName = document.getElementById('device-name').value.trim();
      if (!deviceName) {
        alert('Please enter your name or device name');
        return;
      }

      const btn = document.getElementById('request-btn');
      btn.disabled = true;
      btn.textContent = 'Requesting...';

      try {
        // Detect platform
        let platform = 'web';
        const ua = navigator.userAgent.toLowerCase();
        if (ua.includes('android')) platform = 'android';
        else if (ua.includes('iphone') || ua.includes('ipad')) platform = 'ios';
        else if (ua.includes('mac')) platform = 'macos';
        else if (ua.includes('windows')) platform = 'windows';
        else if (ua.includes('linux')) platform = 'linux';

        // Create request
        const requestData = {
          share_id: shareId,
          device_name: deviceName,
          platform: platform,
          status: 'pending',
          requested_at: new Date().toISOString(),
        };

        const { collection, addDoc } = fbModular;
        const docRef = await addDoc(collection(db, 'shares', shareId, 'requests'), requestData);

        requestId = docRef.id;
        localStorage.setItem(`share_request_${shareId}`, requestId);

        showScreen('pending');
        document.getElementById('pending-info').textContent =
          `Request ID: ${requestId.substring(0, 8)}...`;

        // Start listening for real-time approval updates
        startRequestListener();
      } catch (error) {
        console.error('Error requesting access:', error);
        alert('Failed to request access: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Request Access';
      }
    }

    // Check request status
    async function checkRequestStatus() {
      try {
        const { doc: docFn, getDoc } = fbModular;
        const docSnap = await getDoc(docFn(db, 'shares', shareId, 'requests', requestId));

        if (!docSnap.exists()) {
          // Request was deleted
          localStorage.removeItem(`share_request_${shareId}`);
          requestId = null;
          stopRequestListener();
          showScreen('request');
          return;
        }

        const request = docSnap.data();

        if (request.status === 'approved') {
          stopRequestListener();
          await decryptAndShowContent();
        } else if (request.status === 'denied') {
          stopRequestListener();
          showScreen('denied');
        } else {
          showScreen('pending');
          document.getElementById('pending-info').textContent =
            `Request ID: ${requestId.substring(0, 8)}...`;
          // Start listening for real-time updates
          startRequestListener();
        }
      } catch (error) {
        console.error('Error checking status:', error);
        showError('Failed to check status: ' + error.message);
      }
    }

    // Start real-time listener for request status changes
    function startRequestListener() {
      if (requestListener) return; // Already listening

      const { doc: docFn, onSnapshot } = fbModular;
      requestListener = onSnapshot(docFn(db, 'shares', shareId, 'requests', requestId), (docSnap) => {
        if (!docSnap.exists()) {
          localStorage.removeItem(`share_request_${shareId}`);
          requestId = null;
          stopRequestListener();
          showScreen('request');
          return;
        }

        const request = docSnap.data();
        console.log('Request status changed:', request.status);

        if (request.status === 'approved') {
          stopRequestListener();
          decryptAndShowContent();
        } else if (request.status === 'denied') {
          stopRequestListener();
          showScreen('denied');
        }
      }, (error) => {
        console.error('Request listener error:', error);
      });
    }

    // Stop the real-time listener
    function stopRequestListener() {
      if (requestListener) {
        requestListener();
        requestListener = null;
      }
    }

    async function checkStatus() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Checking...';

      try {
        await checkRequestStatus();
      } finally {
        btn.disabled = false;
        btn.textContent = 'Check Status';
      }
    }

    // Decrypt content using Web Crypto API
    async function decryptContent(encryptedBase64, nonceBase64, keyBase64) {
      try {
        // Decode from base64
        const encrypted = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
        const nonce = Uint8Array.from(atob(nonceBase64), c => c.charCodeAt(0));
        const keyBytes = Uint8Array.from(atob(keyBase64.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0));

        // Import key
        const key = await crypto.subtle.importKey(
          'raw',
          keyBytes,
          { name: 'AES-GCM' },
          false,
          ['decrypt']
        );

        // Note: The ciphertext includes the MAC at the end
        // XChaCha20-Poly1305 is not directly supported in Web Crypto
        // We'll need to use a JavaScript library or adjust the encryption

        // For now, let's try with the assumption that we're using AES-GCM
        // The server-side should use AES-GCM for web compatibility
        const decrypted = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv: nonce },
          key,
          encrypted
        );

        return new TextDecoder().decode(decrypted);
      } catch (error) {
        console.error('Decryption error:', error);
        throw new Error('Failed to decrypt content. The link may be invalid.');
      }
    }

    // Decrypt binary data (attachments)
    // Format: nonce (12 bytes) + ciphertext + MAC (16 bytes)
    async function decryptBytes(encryptedBytes, keyBase64) {
      try {
        const keyBytes = Uint8Array.from(
          atob(keyBase64.replace(/-/g, '+').replace(/_/g, '/')),
          c => c.charCodeAt(0)
        );

        // Extract nonce (first 12 bytes)
        const nonce = encryptedBytes.slice(0, 12);
        // Rest is ciphertext + MAC
        const ciphertext = encryptedBytes.slice(12);

        // Import key
        const key = await crypto.subtle.importKey(
          'raw',
          keyBytes,
          { name: 'AES-GCM' },
          false,
          ['decrypt']
        );

        // Decrypt
        const decrypted = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv: nonce },
          key,
          ciphertext
        );

        return new Uint8Array(decrypted);
      } catch (error) {
        console.error('Bytes decryption error:', error);
        throw error;
      }
    }

    // Download and decrypt attachment
    async function loadAttachment(attachment, container) {
      try {
        // Fetch encrypted bytes from storage URL
        const response = await fetch(attachment.downloadUrl);
        if (!response.ok) throw new Error('Failed to download attachment');

        const encryptedBytes = new Uint8Array(await response.arrayBuffer());

        // Decrypt
        const decryptedBytes = await decryptBytes(encryptedBytes, shareKey);

        // Create blob and URL
        const blob = new Blob([decryptedBytes], { type: attachment.mimeType });
        const url = URL.createObjectURL(blob);

        // Update container based on type
        if (attachment.type === 'image' || attachment.type === 'sketch') {
          const img = container.querySelector('img');
          img.src = url;
          img.onclick = () => openLightbox(url);
          container.classList.remove('loading');
        } else if (attachment.type === 'audio') {
          const audio = container.querySelector('audio');
          audio.src = url;
          container.classList.remove('loading');
        }
      } catch (error) {
        console.error('Error loading attachment:', error);
        container.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--error);">Failed to load</div>';
      }
    }

    // Lightbox functions
    function openLightbox(src) {
      document.getElementById('lightbox-img').src = src;
      document.getElementById('lightbox').classList.add('active');
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('active');
    }

    // Show decrypted content
    async function decryptAndShowContent() {
      try {
        showScreen('loading');

        // Try to decrypt (this will work if we switch to AES-GCM on server)
        let content;
        try {
          content = await decryptContent(
            shareData.encrypted_content,
            shareData.encrypted_content_nonce,
            shareKey
          );
        } catch (e) {
          // Show a message that the content needs the app
          showError('Web decryption is not yet supported. Please use the Better Keep app to view this shared note.');
          return;
        }

        // Parse and display
        showScreen('content');

        // Set title
        document.getElementById('note-title').textContent =
          shareData.note_title || 'Shared Note';

        // Render markdown content
        document.getElementById('note-body').innerHTML = marked.parse(content);

        // Handle attachments
        console.log('Share data:', shareData);
        console.log('Has encrypted_attachments:', !!shareData.encrypted_attachments);
        console.log('Has encrypted_attachments_nonce:', !!shareData.encrypted_attachments_nonce);

        if (shareData.encrypted_attachments && shareData.encrypted_attachments_nonce) {
          try {
            console.log('Decrypting attachments...');
            const attachmentsJson = await decryptContent(
              shareData.encrypted_attachments,
              shareData.encrypted_attachments_nonce,
              shareKey
            );
            console.log('Decrypted attachments JSON:', attachmentsJson);
            const attachments = JSON.parse(attachmentsJson);
            console.log('Parsed attachments:', attachments);

            if (attachments && attachments.length > 0) {
              console.log('Rendering', attachments.length, 'attachments');
              await renderAttachments(attachments);
            } else {
              console.log('No attachments to render');
            }
          } catch (e) {
            console.error('Error decrypting attachments:', e);
          }
        } else {
          console.log('No encrypted attachments in share data');
        }

      } catch (error) {
        console.error('Error showing content:', error);
        showError(error.message);
      }
    }

    // Render attachments
    async function renderAttachments(attachments) {
      const section = document.getElementById('attachments-section');
      const grid = document.getElementById('attachments-grid');

      section.style.display = 'block';
      grid.innerHTML = '';

      for (const attachment of attachments) {
        const item = document.createElement('div');
        item.className = 'attachment-item loading';

        if (attachment.type === 'image' || attachment.type === 'sketch') {
          item.innerHTML = '<img src="" alt="Attachment">';
        } else if (attachment.type === 'audio') {
          item.className = 'attachment-item attachment-audio loading';
          item.innerHTML = `
            <div class="audio-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 32px; height: 32px; color: var(--accent);">
                <path d="M9 18V5l12-2v13"/>
                <circle cx="6" cy="18" r="3"/>
                <circle cx="18" cy="16" r="3"/>
              </svg>
            </div>
            <div class="audio-title">${attachment.title || 'Audio Recording'}</div>
            <audio controls preload="none"></audio>
          `;
        }

        grid.appendChild(item);

        // Start loading in background
        loadAttachment(attachment, item);
      }
    }

    // Initialize the app
    async function init() {
      try {
        // Wait for Firebase module to be ready
        await waitForFirebase();

        // Get Firebase instances from the module
        db = window.firebaseDb;
        storage = window.firebaseStorage;
        fbModular = window.firebaseModular;

        // Parse URL and load share
        parseUrl();
        await loadShare();
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize: ' + error.message);
      }
    }

    // Start initialization
    init();
  </script>
</body>

</html>