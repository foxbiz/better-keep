rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user has an active Pro subscription
    // Uses custom claims set by Cloud Functions when subscription is verified
    function isPro() {
      return request.auth.token.plan == 'pro' 
        && request.auth.token.planExpiresAt != null
        && request.auth.token.planExpiresAt > request.time.toMillis();
    }

    // Match files under users/{userId}/...
    match /users/{userId}/{allPaths=**} {
      // Allow reads for all authenticated owners (needed for downloading attachments)
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Only Pro users can upload/modify files
      allow write: if request.auth != null 
        && request.auth.uid == userId 
        && isPro();
    }

    // Share attachments - publicly readable (content is encrypted)
    // Path includes userId to verify ownership on writes
    match /shares/{userId}/{shareId}/attachments/{filename} {
      // Anyone can read (content is encrypted, decryption requires share key)
      allow read: if true;
      
      // Only the share owner can upload/modify attachments
      allow write: if request.auth != null 
        && request.auth.uid == userId;
    }
  }
}
